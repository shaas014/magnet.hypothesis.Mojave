---
title: ""
author: "cjlortie and ally ruttan"
date: "March 2017"
output:
  html_document:
    theme: yeti
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
![](./MNP.jpg)

### Magnet hypothesis: plant-pollinator interactions
**Purpose:** A test of the magnet hypothesis was examined in Mojave National Preserve by Ally Ruttan.    

**Hypothesis:** Floral resource island created by shrubs and the associated beneficiary annual plants will positively and non-additively influence pollinator visitation rates. 

**Predictions:**  
(1) The frequency and duration of pollinator visitations to annuals is greater under shrubs than in the paired-open microsites (magnet H because of concentration).  
(2) Annual plants under flowering entomophilous shrubs (*Larrea tridentata*) will have a higher frequency and duration of pollinator visitations than annual plants under anemophilous shrubs (*Ambrosia dumosa*) because of higher concentrations of suitable floral resources for pollinators (specificity of pollinator faciliation).  
(3) Shrubs with annuals in their understory will have a higher frequency and duration of pollinator visitations than shrubs without annuals due to increased concentrations of floral resources for pollinators (reverse magnet effect and reciprocal benefits).  
(4) Sites with both shrubs and annuals will have the highest frequency and duration of pollinator visitations to both the shrubs and the annuals (i.e. annuals under shrubs also with flowers are visited the most).

An interesting corollary is that there are appropriate floral resources for desert pollinators, that they discriminate, and that entomophilous and anemophilous shrubs facilitate flowering similarly.

![](./map.jpg)

###Data wrangling
```{r library and data loads, warning=FALSE, message=FALSE}
#libraries
library(tidyverse)
library(DT)
library(lubridate)

#meta-data
meta <- read_csv("data/meta-data.csv")
datatable(meta)

#data
data.2015 <- read_csv("data/MNP.2015.csv")
data.2016 <- read_csv("data/MNP.2016.csv")

#merge
data <- rbind.data.frame(data.2015, data.2016)
data <- data %>% rename(net.treatment = treatment) %>% na.omit(data) 
data$year <- as.character(data$year)
data$rep <- as.character(data$rep)

#tidy data to expand treatment column (current structure is a mix of three factors)
#microsite
data <- data %>% mutate(microsite = ifelse(net.treatment %in% c("SA", "SAA", "SX"), "Larrea", ifelse(net.treatment %in% c("OA"), "open", ifelse(net.treatment %in% c("AMB"), "Ambrosia", NA))))
length(unique(data$microsite))

#annuals present
data <- data %>% mutate(annuals = ifelse(net.treatment %in% c("SA", "SAA"), "annuals", ifelse(net.treatment %in% c("OA"), "annuals", ifelse(net.treatment %in% c("AMB"), "annuals", "none"))))
length(unique(data$annuals))

#target flowers
data <- data %>% mutate(target.flowers = ifelse(net.treatment %in% c("SA", "SX"), "shrub flowers", ifelse(net.treatment %in% c("AMB", "SAA", "OA"), "annual plant flowers", "NA")))
length(unique(data$annuals))

#frequency counts in a separate dataframe (weighted by duration of recording)
frequency <- data %>% group_by(year, day, net.treatment, rep, microsite, annuals, target.flowers) %>% summarise(net.time = sum(total.duration), mean.visitation.duration = mean(visitation.duration), mean.floral.density = mean(floral.density), mean.insect.RTU = n_distinct(insect.RTU), count = n())

frequency$net.time <- as.numeric(frequency$net.time) #converts to total seconds
frequency$mean.visitation.duration <- as.numeric(frequency$mean.visitation.duration) #converts to total seconds
frequency$count <- as.numeric(frequency$count)

frequency$rate <- as.numeric(frequency$count)/frequency$net.time #weight by net time
frequency$proportion.visitations <- frequency$mean.visitation.duration/frequency$net.time
frequency$rate.per.flower <- frequency$count/frequency$mean.floral.density
datatable(frequency)

#repeat above with RTU as factor
frequency.by.RTU <- data %>% group_by(year, day, net.treatment, insect.RTU, rep, microsite, annuals, target.flowers) %>% summarise(net.time = sum(total.duration), mean.visitation.duration = mean(visitation.duration), mean.floral.density = mean(floral.density), count = n())

frequency.by.RTU$net.time <- as.numeric(frequency.by.RTU$net.time) #converts to total seconds
frequency.by.RTU$mean.visitation.duration <- as.numeric(frequency.by.RTU$mean.visitation.duration) #converts to total seconds
frequency.by.RTU$count <- as.numeric(frequency.by.RTU$count)

frequency.by.RTU$rate <- as.numeric(frequency.by.RTU$count)/frequency.by.RTU$net.time #weight by net time
frequency.by.RTU$proportion.visitations <- frequency.by.RTU$mean.visitation.duration/frequency.by.RTU$net.time
frequency.by.RTU$rate.per.flower <- frequency.by.RTU$count/frequency.by.RTU$mean.floral.density
datatable(frequency.by.RTU)

#repeat above but with RTU as species diversity response

#split out by year because of non-orthogonality
freq.2015 <- frequency %>% filter(year == 2015)
freq.2016 <- frequency %>% filter(year == 2016)

```

### Data visualization
```{r viz, warning=FALSE, message=FALSE}
#Higher-order treatment patterns in frequency####
#Collapsed single factor model
ggplot(frequency, aes(net.treatment, rate)) + geom_boxplot() + facet_wrap(~year)

ggplot(frequency, aes(net.treatment, proportion.visitations)) + geom_boxplot() + facet_wrap(~year)

ggplot(frequency, aes(microsite, rate, fill = target.flowers)) + geom_boxplot() + facet_wrap(~year) + scale_fill_brewer(palette = "YlGn")

#relationships with sampling effort
ggplot(frequency, aes(net.time, count, color = year)) + geom_point()

ggplot(frequency, aes(net.time, count, color = year)) + geom_point() + facet_wrap(~microsite)

#floral density
ggplot(frequency, aes(mean.floral.density, rate, color = year)) + geom_point()

ggplot(frequency, aes(mean.floral.density, rate, color = microsite)) + geom_point() + facet_wrap(~year)

ggplot(frequency, aes(mean.floral.density, rate, color = microsite)) + geom_point() + facet_wrap(~year)

#mean visitation duration is also really important because you have more visits or longer visits####
ggplot(frequency, aes(net.treatment, mean.visitation.duration, color = microsite)) + geom_boxplot() + facet_wrap(~year)

#relationships with sampling effort
ggplot(frequency, aes(net.time, mean.visitation.duration, color = year)) + geom_point() + facet_wrap(~microsite*target.flowers)

#floral density
ggplot(frequency, aes(mean.floral.density, mean.visitation.duration, color = year)) + geom_point() + facet_wrap(~microsite)

```

###EDA
```{r EDA, warning=FALSE, message=FALSE}
#test distributions and explore outliers
summary(frequency)
require(fitdistrplus)
descdist(freq.2015$rate, boot = 1000)
descdist(freq.2016$rate, boot = 1000)
detach("package:fitdistrplus", unload = TRUE)

#explore temperature on count and mean visitation rates


```

###Models
```{r models, warning=FALSE, message=FALSE}
#GLM for count and weight by net.time (alt - use MASS and glm.nb)
#library(MASS) #need for glm.nb

#all codes
#2015 counts
m <- glm(count~net.treatment + mean.floral.density, family = "poisson", weight = net.time, data = freq.2015)
anova(m, test = "Chisq") 

#posthoc test
require(lsmeans)
lsmeans(m, pairwise~net.treatment, adjust="tukey")

#2016 counts
m <- glm(count~net.treatment + mean.floral.density, family = "poisson", weight = net.time, data = freq.2016)
anova(m, test = "Chisq") 

#posthoc test
require(lsmeans)
lsmeans(m, pairwise~net.treatment, adjust="tukey")

#repeat above for mean.visitation.duration
#2015
m <- glm(mean.visitation.duration~net.treatment + mean.floral.density, family = "gaussian", weight = net.time, data = freq.2015)
anova(m, test = "Chisq") 

#posthoc test
require(lsmeans)
lsmeans(m, pairwise~net.treatment, adjust="tukey")

#2016
m <- glm(mean.visitation.duration~net.treatment + mean.floral.density, family = "gaussian", weight = net.time, data = freq.2016)
anova(m, test = "Chisq") 

#posthoc test
require(lsmeans)
lsmeans(m, pairwise~net.treatment, adjust="tukey")

#treatments split out
#how to test?

```

###Interpretation
**Net.treatment models**  
1. Using the simplest models with all treatment levels aggregated but split by years, larrea is the most important magnet for frequency of visits (weighting for net.time recorded and using floral density as a covariate). This is a reasonable test because it captures enough of the variation and address non-orthogonality levels.\

2. Mean visitation rate in 2015 significantly differed between larea with flowers and open and larea with flowers and annuals versus larrea without. This strongly suggests a double-magnet effect this season. In 2016, larrea flowering with annuals was also significantly greater than open microsites with annuals.

3. Double-magnet supported for frequency too.

4. Then check each prediction. Need to think over how to handle double-magnet H.




