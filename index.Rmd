---
title: ''
author: "cjlortie and ally ruttan"
date: "April 2017"
output:
  html_document:
    theme: yeti
    toc: yes
    toc_depth: 3
    toc_float: yes
    always_allow_html: yes
---

![](./MNP.jpg)

### Magnet hypothesis: plant-pollinator interactions
**Purpose:** A test of the magnet hypothesis was examined in Mojave National Preserve by Ally Ruttan.    

**Hypothesis:** Floral resource island created by shrubs and the associated beneficiary annual plants will positively and non-additively influence pollinator visitation rates. 

**Predictions:**  
(1) The frequency and duration of pollinator visitations to annuals is greater under shrubs than in the paired-open microsites (magnet H because of concentration).  
(2) Annual plants under flowering entomophilous shrubs (*Larrea tridentata*) will have a higher frequency and duration of pollinator visitations than annual plants under anemophilous shrubs (*Ambrosia dumosa*) because of higher concentrations of suitable floral resources for pollinators (specificity of pollinator faciliation).  
(3) Shrubs with annuals in their understory will have a higher frequency and duration of pollinator visitations than shrubs without annuals due to increased concentrations of floral resources for pollinators (reverse magnet effect and reciprocal benefits).  
(4) Sites with both shrubs and annuals will have the highest frequency and duration of pollinator visitations to both the shrubs and the annuals (i.e. annuals under shrubs also with flowers are visited the most).

An interesting corollary is that there are appropriate floral resources for desert pollinators, that they discriminate, and that entomophilous and anemophilous shrubs facilitate flowering similarly.

![](./map.jpg)

###Data wrangling
```{r library and data loads, warning=FALSE, message=FALSE}
#libraries####
library(tidyverse)
library(DT)
library(lubridate)

#meta-data####
meta <- read_csv("data/meta-data.csv")
datatable(meta)
#error is SD

#data####
data.2015 <- read_csv("data/MNP.2015.csv")
data.2016 <- read_csv("data/MNP.2016.csv")

#merge
data <- rbind.data.frame(data.2015, data.2016)

#code treatment properly
data <- data %>% rename(net.treatment = treatment) #%>% na.omit(data) 

#keep key columns and minimize working dataframe
data <- data %>% select(-name, -plant, -start, -stop, -ID, -recorder) %>% filter(insect.RTU != "none")

#set year and rep as characters
data$year <- as.character(data$year)
data$rep <- as.character(data$rep)

#convert times to total seconds then to hour
data$total.duration <- (as.numeric(data$total.duration))/3600
data$visitation.duration <- (as.numeric(data$visitation.duration))/3600

#recode net.treatment column
data <- data %>% mutate(net.treatment = ifelse(net.treatment %in% c("SA"), "Larrea flowers with annuals", ifelse(net.treatment %in% c("SX"), "Larrea flowers without annuals", ifelse(net.treatment %in% c("SAA"), "Annual flowers under Larrea",ifelse(net.treatment %in% c("OA"), "Annual flowers in open",ifelse(net.treatment %in% c("AMB"), "Annual flowers under Ambrosia","NA"))))))

#frequency wrangled by RTU####
frequency <- data %>% group_by(year, day, net.treatment, rep, insect.RTU) %>% 
  summarise(net.time = sum(total.duration), mean.time = mean(total.duration), mean.temp = mean(temperature), mean.var.temp = mean(error), net.visitation = sum(visitation.duration), mean.visitation.duration = mean(visitation.duration), net.floral.density = sum(floral.density), mean.floral.density = mean(floral.density), insect.richness = n_distinct(insect.RTU), count = n())

#rates needed
frequency <- frequency %>% mutate(rate.per.flower = (count/mean.floral.density)) 

#view frequency data
datatable(frequency)

#separate net.treatment to individual vectors/factors
#Expt 1. Single-magnet hypothesis
expt1 <- frequency %>% filter(net.treatment == "Annual flowers under Larrea" | net.treatment == "Annual flowers in open" | net.treatment == "Annual flowers under Ambrosia")

expt1 <- expt1 %>% mutate(microsite = ifelse(net.treatment %in% c("Annual flowers under Larrea"), "Larrea", ifelse(net.treatment %in% c("Annual flowers under Ambrosia"), "Ambrosia", ifelse(net.treatment %in% c("Annual flowers in open"), "open", "NA"))))

#by years
expt1.2015 <- expt1 %>% filter(year == 2015)
expt1.2016 <- expt1 %>% filter(year == 2016)

#Expt2. Shrub flower-annual interactions through pollinators
expt2 <- frequency %>% filter(net.treatment == "Larrea flowers with annuals" | net.treatment == "Larrea flowers without annuals") 

expt2 <- expt2 %>% mutate(treatment = ifelse(net.treatment %in% c("Larrea flowers with annuals"), "Larrea + annuals", ifelse(net.treatment %in% c("Larrea flowers without annuals"), "Larrea - annuals", "NA")))

expt2.2015 <- expt2 %>% filter(year == 2015)
expt2.2016 <- expt2 %>% filter(year == 2016)

#Data structure: A total of 4 dataframes, two experiments, two years each#S

```

### Data visualization
```{r viz, warning=FALSE, message=FALSE}
#expt1####
#visitations####
#unweighted
ggplot(expt1, aes(microsite, rate.per.flower, fill = insect.RTU)) + geom_boxplot() + ylab("rate per flower") + scale_fill_brewer(palette = "Blues") + facet_grid(~year)

#weighted
ggplot(expt1, aes(microsite, rate.per.flower/mean.time, fill = insect.RTU)) + geom_boxplot() + ylab("rate per flower") + scale_fill_brewer(palette = "Blues") + facet_grid(~year)

#ggplot(expt1, aes(microsite, rate.per.flower/mean.time, fill = insect.RTU)) + geom_bar(stat="identity") + ylab("rate per flower") + scale_fill_brewer(palette = "Blues") + facet_grid(~year)

#visit durations####
#net visitation time
expt1 <- expt1 %>% filter(net.visitation < 2)
ggplot(expt1, aes(microsite, net.visitation, fill = insect.RTU)) + geom_boxplot() + ylab("net duration of visits per hour") + scale_fill_brewer(palette = "Blues") + facet_grid(~year)

expt1 <- expt1 %>% filter(net.visitation < 2)
ggplot(expt1, aes(microsite, net.visitation/mean.time, fill = insect.RTU)) + geom_boxplot() + ylab("net duration of visits per hour") + scale_fill_brewer(palette = "Blues") + facet_grid(~year)

#expt1 <- expt1 %>% filter(net.visitation < 2)
#ggplot(expt1, aes(microsite, net.visitation/mean.time, fill = insect.RTU)) + geom_bar(stat= "identity") + ylab("net duration of visits per hour") + scale_fill_brewer(palette = "Blues") + facet_grid(~year)

#temperature####
ggplot(expt1, aes(mean.temp, rate.per.flower/mean.time, color = insect.RTU)) + geom_point() + ylab("rate per flower") + geom_smooth(method = "lm") + facet_wrap(~year) + scale_color_brewer(palette = "GnBu")

#floral density####
ggplot(expt1, aes(net.floral.density, count, color = insect.RTU)) + geom_point() + ylab("count") + geom_smooth(method = "lm") + facet_wrap(~year) + scale_color_brewer(palette = "GnBu")

#expt2####
#visitations####
expt2 <- expt2 %>% filter(rate.per.flower < 0.25)
ggplot(expt2, aes(treatment, rate.per.flower/mean.time, fill = insect.RTU)) + geom_boxplot() + ylab("rate per flower") + scale_fill_brewer(palette = "Blues") + facet_grid(~year)

#visit durations####
#net visitation time
expt2 <- expt2 %>% filter(net.visitation < 0.02)
ggplot(expt2, aes(treatment, net.visitation/mean.time, fill = insect.RTU)) + geom_boxplot() + ylab("net duration of visits per hour") + scale_fill_brewer(palette = "Blues") + facet_grid(~year)

#temperature####
ggplot(expt2, aes(mean.temp, rate.per.flower/mean.time, color = insect.RTU)) + geom_point() + ylab("rate per flower") + geom_smooth(method = "lm") + facet_wrap(~year) + scale_color_brewer(palette = "Blues")

#floral density####
ggplot(expt2, aes(net.floral.density, count, color = insect.RTU)) + geom_point() + ylab("count") + geom_smooth(method = "lm") + facet_wrap(~year) + scale_color_brewer(palette = "Blues")

```

###Models
```{r model all with additive terms, warning=FALSE, message=FALSE}
#Additive-term models for all insect taxa####
#expt1####
#2015####
#visitations
m <- glm(rate.per.flower~microsite*insect.RTU + mean.temp + offset(mean.time), family = "quasipoisson", data = expt1.2015)
anova(m, test = "Chisq")
require(lsmeans)
lsmeans(m, pairwise~microsite*insect.RTU, adjust="tukey")
#require(multcomp)
#ph <- glht(m) #tests different from no effect
#summary(ph)

#do we need to add in rep at all as a nested, random effect?
m <- glm(rate.per.flower~microsite*insect.RTU%in%rep + mean.temp + offset(mean.time), family = "quasipoisson", data = expt1.2015)
anova(m, test = "Chisq")
require(lsmeans)
lsmeans(m, pairwise~microsite*insect.RTU, adjust="tukey")


#visit duration####
m <- glm(net.visitation~microsite*insect.RTU + mean.temp + offset(mean.time), family = "gaussian", data = expt1.2015)
anova(m, test = "Chisq")
#lsmeans(m, pairwise~microsite*insect.RTU, adjust="tukey")

#2016####
#visitations
m <- glm(rate.per.flower~microsite*insect.RTU + mean.temp + offset(mean.time), family = "quasipoisson", data = expt1.2016)
anova(m, test = "Chisq")
lsmeans(m, pairwise~microsite*insect.RTU, adjust="tukey")
#require(multcomp)
#ph <- glht(m) #tests different from no effect
#summary(ph)

#visit duration####
m <- glm(net.visitation~microsite*insect.RTU + mean.temp + offset(mean.time), family = "gaussian", data = expt1.2016)
anova(m, test = "Chisq")
#lsmeans(m, pairwise~microsite*insect.RTU, adjust="tukey")

#expt2####
#2015####
#visitations
m <- glm(rate.per.flower~net.treatment*insect.RTU + mean.temp + offset(mean.time), family = "quasipoisson", data = expt2.2015)
anova(m, test = "Chisq")
#lsmeans(m, pairwise~net.treatment*insect.RTU, adjust="tukey")
#require(multcomp)
#ph <- glht(m) #tests different from no effect
#summary(ph)

#visit duration####
m <- glm(net.visitation~net.treatment*insect.RTU + mean.temp + offset(mean.time), family = "gaussian", data = expt2.2015)
anova(m, test = "Chisq")
#lsmeans(m, pairwise~net.treatment*insect.RTU, adjust="tukey")

#2016####
#visitations
m <- glm(rate.per.flower~net.treatment*insect.RTU + mean.temp + offset(mean.time), family = "quasipoisson", data = expt2.2016)
anova(m, test = "Chisq")
lsmeans(m, pairwise~net.treatment*insect.RTU, adjust="tukey")
#require(multcomp)
#ph <- glht(m) #tests different from no effect
#summary(ph)

#visit duration####
m <- glm(net.visitation~net.treatment*insect.RTU + mean.temp + offset(mean.time), family = "gaussian", data = expt2.2016)
anova(m, test = "Chisq")
lsmeans(m, pairwise~net.treatment*insect.RTU, adjust="tukey")

#temp####
#bees only
fit <- lm(rate.per.flower~mean.temp, data = subset(expt1.2015, insect.RTU == "bees"))
summary(fit) 

fit <- lm(rate.per.flower~mean.temp, data = subset(expt1.2016, insect.RTU == "bees"))
summary(fit)

#floral density####
#bees only
#expt1
fit <- lm(count~net.floral.density, data = subset(expt1.2015, insect.RTU == "bees"))
summary(fit)
a1 <- AIC(fit)

fit <- lm(count~net.floral.density, data = subset(expt1.2016, insect.RTU == "bees"))
summary(fit) 
a2 <- AIC(fit)

#expt2
fit <- lm(count~net.floral.density, data = subset(expt2.2015, insect.RTU == "bees"))
summary(fit)
a3 <- AIC(fit)

fit <- lm(count~net.floral.density, data = subset(expt2.2016, insect.RTU == "bees"))
summary(fit) 
a4 <- AIC(fit)

#contrasts between annual and shrub flowers
#Quick interactive-term vs additive-term model comparison
x <- c(a1,a2)
x
y <- c(a3, a4)
y
z <- abs(x-y)
z

```

###Interpretation  
1. There is support for the single-magnet hypothesis through bees.
2. Both shrub species can generally facilitate annuals through pollination through bees.
3. Taxa specificity in plant-pollinator associations is critical for both foundation and annual plant species 
4. Larrea flowers are less attractive to bees relative to annuals within this ecosystem.  
5. Bees repond to temp by increasing visitation rates to annuals.
6. Bees respond to positively to increasing floral density of both annual and Larrea flowers.
7. There is evidence that shrubs receive no reciprocal benefit or facilitation from annuals, and furthermore, that there is a cost to facilitation by these foundation shrubs.
8. Bees are the most effective pollinators, i.e. they also spend the most time with annual flowers and likely are the most effective service pollinators.


